<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <link rel="stylesheet" href="./css/style.css">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <script src="//at.alicdn.com/t/font_481346_n38mib688ckdquxr.js"></script>
    <title>画板</title>
</head>

<body>
    <canvas id="drawCanvas" width=300 height=300></canvas>
    <div id=actions class="actions">
            <svg id="pen" class="icon active" aria-hidden="true">
                <use xlink:href="#icon-pen"></use>
            </svg>
            <svg id="eraser" class="icon" aria-hidden="true">
                    <use xlink:href="#icon-eraser"></use>
            </svg>
            <svg id="save" class="icon" aria-hidden="true">
                    <use xlink:href="#icon-save"></use>
            </svg>
            <svg id="colorBar" class="icon" aria-hidden="true">
                    <use xlink:href="#icon-yanse"></use>
            </svg>
    </div>
    <script>
        var yyy = document.getElementById('drawCanvas');
        var context = yyy.getContext('2d');

        // 窗口的检测以及画板的最大化
        autoSetCanvasSize(yyy)

        //检测鼠标的使用情况
        listenToUser(yyy)

        var eraserEnabled = false
        pen.onclick = function(){
            eraserEnabled = false
            pen.classList.add('active')
            eraser.classList.remove('active')
        }
        eraser.onclick = function(){
            eraserEnabled = true
            eraser.classList.add('active')
            pen.classList.remove('active')
        }

        /***局部变量的 具体过程***/
        //关于窗口的设定
        function autoSetCanvasSize(canvas) {
            setCanvasSize()
            window.onresize = function () {
                setCanvasSize()
            }

            function setCanvasSize() {
                var pageWidth = document.documentElement.clientWidth
                var pageHeight = document.documentElement.clientHeight

                canvas.width = pageWidth
                canvas.height = pageHeight
            }
        }

        function drawLine(x1, y1, x2, y2) {
            context.beginPath();
            context.strokeStyle = 'black'
            context.moveTo(x1, y1) // 起点
            context.lineWidth = 5
            context.lineTo(x2, y2) // 终点
            context.stroke()
            context.closePath()
        }

        function listenToUser(canvas) {
            var using = false
            var lastPoint = {
                x: undefined,
                y: undefined
            }
            //特性检测
            if (document.body.ontouchstart !== undefined) {
                //触屏手机
                canvas.ontouchstart = function (aaa) {
                    var x = aaa.touches[0].clientX
                    var y = aaa.touches[0].clientY
                    using = true
                    if (eraserEnabled) {
                        context.clearRect(x - 5, y - 5, 10, 10)
                    } else {
                        lastPoint = {
                            "x": x,
                            "y": y
                        }
                    }
                }

                canvas.ontouchmove = function (aaa) {
                    var x = aaa.touches[0].clientX
                    var y = aaa.touches[0].clientY
                    if (!using) {
                        return
                    }
                    if (eraserEnabled) {
                        context.clearRect(x - 5, y - 5, 10, 10)
                    } else {
                        var newPoint = {
                            "x": x,
                            "y": y
                        }
                        drawLine(lastPoint.x, lastPoint.y, newPoint.x, newPoint.y)
                        lastPoint = newPoint
                    }
                }
                canvas.ontouchend = function (aaa) {
                    using = false
                }
            } else {
                //是电脑 
                canvas.onmousedown = function (aaa) {
                    var x = aaa.clientX
                    var y = aaa.clientY
                    using = true
                    if (eraserEnabled) {
                        context.clearRect(x - 5, y - 5, 10, 10)
                    } else {
                        lastPoint = {
                            "x": x,
                            "y": y
                        }
                    }
                }
                canvas.onmousemove = function (aaa) {
                    var x = aaa.clientX
                    var y = aaa.clientY

                    if (!using) {
                        return
                    }

                    if (eraserEnabled) {
                        context.clearRect(x - 5, y - 5, 10, 10)
                    } else {
                        var newPoint = {
                            "x": x,
                            "y": y
                        }
                        drawLine(lastPoint.x, lastPoint.y, newPoint.x, newPoint.y)
                        lastPoint = newPoint
                    }
                }
                canvas.onmouseup = function (aaa) {
                    using = false
                }
            }

        }
    </script>
</body>

</html>